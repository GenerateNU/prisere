# Prisere ðŸª·

Prisere is an all-in-one platform to empower Small-Medium Sized Businesses (SMBs) during times of disaster by smoothing the business-interruption claims process.

## Table of Contents

1. [File Structure](#file-structure)
2. [Running the App](#running-the-app)
3. [Database Management](#database-management)
4. [Type Generation](#type-generation)

### File-Structure

The template repository is laid out as follows below.

```bash
.
â”œâ”€â”€ README.md                         
â”œâ”€â”€ backend                            
â”‚   â”œâ”€â”€ Dockerfile                     # Container configuration for backend
â”‚   â”œâ”€â”€ README.md                      
â”‚   â”œâ”€â”€ bun.lock                 
â”‚   â”œâ”€â”€ package.json                   # Backend dependencies and scripts
â”‚   â”œâ”€â”€ requirements.txt               # Python dependencies
â”‚   â”œâ”€â”€ src                            
â”‚   â”‚   â”œâ”€â”€ database                   # Database utilities, factories, and seeds
â”‚   â”‚   â”œâ”€â”€ dayjs.config.ts            # Date/time library configuration
â”‚   â”‚   â”œâ”€â”€ entities                   # TypeORM entity definitions
â”‚   â”‚   â”œâ”€â”€ eslint.config.ts           
â”‚   â”‚   â”œâ”€â”€ external                   # Third-party integrations (Quickbooks)
â”‚   â”‚   â”œâ”€â”€ lambda                     # AWS Lambda function handlers for email sending
â”‚   â”‚   â”œâ”€â”€ migrations                 # Database migration files
â”‚   â”‚   â”œâ”€â”€ modules                    # API endpoint modules
â”‚   â”‚   â”œâ”€â”€ routes.ts                  # Route definitions and setup
â”‚   â”‚   â”œâ”€â”€ server.ts                  # Express server entry point
â”‚   â”‚   â”œâ”€â”€ tests                      # Backend test suites
â”‚   â”‚   â”œâ”€â”€ typeorm-config.ts          
â”‚   â”‚   â”œâ”€â”€ types                      # TypeScript type definitions
â”‚   â”‚   â””â”€â”€ utilities                  # Helper functions and utilities
â”‚   â”œâ”€â”€ supabase                       
â”‚   â”‚   â”œâ”€â”€ MIGRATION_TUTORIAL.md      # Guide for database migrations
â”‚   â”‚   â”œâ”€â”€ config.toml                # Supabase configuration
â”‚   â”‚   â””â”€â”€ signing_key.json           # JWT signing key for local auth
â”‚   â”œâ”€â”€ terraform                      
â”‚   â”‚   â”œâ”€â”€ INSTRUCTIONS.md           
â”‚   â”‚   â”œâ”€â”€ backend.tf                 # Backend infrastructure definitions
â”‚   â”‚   â”œâ”€â”€ iam.tf                     # IAM roles and policies
â”‚   â”‚   â”œâ”€â”€ lambda.tf                  # Lambda function resources
â”‚   â”‚   â”œâ”€â”€ main.tf                    # Main Terraform configuration
â”‚   â”‚   â”œâ”€â”€ outputs.tf                 # Output values from Terraform
â”‚   â”‚   â”œâ”€â”€ s3.tf                      # S3 bucket configurations
â”‚   â”‚   â”œâ”€â”€ terraform.tfvars           # Default Terraform variables
â”‚   â”‚   â”œâ”€â”€ terraform.tfvars.dev       # Development environment variables
â”‚   â”‚   â”œâ”€â”€ terraform.tfvars.prod      # Production environment variables
â”‚   â”‚   â””â”€â”€ variables.tf               # Variable declarations
â”‚   â””â”€â”€ tsconfig.json                  
â”œâ”€â”€ bun.lock                           
â”œâ”€â”€ docker-compose.yaml                
â”œâ”€â”€ frontend                           
â”‚   â”œâ”€â”€ Dockerfile                     
â”‚   â”œâ”€â”€ README.md                      
â”‚   â”œâ”€â”€ actions                        
â”‚   â”‚   â””â”€â”€ auth.ts                    # Authentication server actions
â”‚   â”œâ”€â”€ api                            # API client layer
â”‚   â”œâ”€â”€ app                            # Next.js app directory (routes)
â”‚   â”œâ”€â”€ bun.lock                       
â”‚   â”œâ”€â”€ components                     # Reusable React components
â”‚   â”œâ”€â”€ components.json                
â”‚   â”œâ”€â”€ eslint.config.mjs              # ESLint configuration
â”‚   â”œâ”€â”€ icons                          # Custom icon components
â”‚   â”œâ”€â”€ lib                            
â”‚   â”‚   â””â”€â”€ utils.ts                   # Common utility functions
â”‚   â”œâ”€â”€ middleware.ts                  # Next.js middleware (auth, etc.)
â”‚   â”œâ”€â”€ next.config.ts                 # Next.js configuration
â”‚   â”œâ”€â”€ package-lock.json          
â”‚   â”œâ”€â”€ package.json                   # Frontend dependencies and scripts
â”‚   â”œâ”€â”€ postcss.config.mjs             
â”‚   â”œâ”€â”€ public                         # Static assets
â”‚   â”œâ”€â”€ schema.d.ts                    # Generated type definitions 
â”‚   â”œâ”€â”€ tsconfig.json                 
â”‚   â”œâ”€â”€ types                          # TypeScript type definitions
â”‚   â””â”€â”€ utils                          # Frontend utility functions
â”œâ”€â”€ package-lock.json                  
â”œâ”€â”€ package.json                      
â”œâ”€â”€ spec.json                          # API specification (generated by script)
â””â”€â”€ tsconfig.json                      # Root TypeScript configuration

```

### Running the App
To deploy the app using Docker Compose run one of the following commands:
```bash
MODE="dev" LOG_VOLUME_MOUNT="./backend/log" docker compose up --build --watch    # in dev more
MODE="prod" LOG_VOLUME_MOUNT="./backend/log" docker compose up --build --watch   # in production mode
```

This will mount both the frontend and backend. `LOG_VOLUME_MOUNT` can be changed to redirect runtime logging. Note that running the backend in dev mode requires your local Supabase to be running - see [Database Management](#database-management) below for instructions.

If you want to run only the backend:
```bash
cd backend
bun run dev # dev mode
# OR 
bun run start # prod mode
```
 
If you want to run only the frontend
```bash
cd frontend
bun run dev # dev mode
# OR
bun run start # prod mode
```

The backend will be available at [localhost:3001](http://localhost:3001/) and the frontend at [localhost:3000](http://localhost:3000/)


### Database Management

We use [Supabase](https://supabase.com/) as a PostgreSQL development platform to manage our databases combined with [TypeORM](https://typeorm.io/). 

To get a Supabase instance running locally, install the Supabase CLI, make sure your Docker engine is running, and run the following commands:
```bash
cd backend/
bun run supabase start
```

See your local Supabase studio at localhost:54323

To migrate your local DB to match the state of prod/git, run:
```bash
bun run migration:dev
```

To run a migration on production (use this command with caution!), run:
```bash
bun run migration:prod
```

To revert a migration in either environment, run:
```bash
bun run migration:dev:revert
# OR
bun run migration:prod:revert
```

To stop your local instance of Supabase, run:
```bash
bun run supabase stop
```

See [MIGRATION_TUTORIAL.md](./backend/supabase/MIGRATION_TUTORIAL.md) for more information about managing migrations with TypeORM.

### Type Generation
We use OpenAPI documentation to generate types for the layer between the frontend and the backend for consistency. The development process should be as follows:

1. Make changes to an api endpoint in the backend. 
2. Update the OpenAPI routes in the associated file in the `/openapi` module.
3. From the root directory, run `bun run gen-types` or `bun run g` to generate new `spec.json` and `schema.d.ts` files.
4. In the `types` folder in the frontend, update imports from the `schema.d.ts` as necessary and use the types in the frontend.

This ensures consistent type expectations for a safe contract between the frontend and the backend. 